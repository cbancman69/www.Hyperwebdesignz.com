<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Track Your Ride — Ride With Ree</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;600;800&display=swap" rel="stylesheet">
  <style>
    :root{--bg-from:#A8E0E8;--bg-via:#B0E8F0;--bg-to:#C0F0F8;--accent:#a855f7}
    html,body{height:100%;margin:0;font-family:Inter,system-ui,Arial;background:linear-gradient(180deg,var(--bg-from),var(--bg-via),var(--bg-to));color:#062324}
    .wrap{min-height:100vh;padding:28px;position:relative}
    .container{max-width:1100px;margin:0 auto}
    .title{font-size:28px;font-weight:800;color:#062234;margin-bottom:6px}
    .muted{color:#556}
    .grid{display:grid;grid-template-columns:1fr 420px;gap:18px}
    .panel{background:#fff;border-radius:12px;padding:12px}
    .map{min-height:420px;border-radius:8px;background:linear-gradient(180deg,#eef6ff,#fff);display:flex;align-items:center;justify-content:center;flex-direction:column}
    .ride-card{padding:10px;border-radius:8px;background:rgba(250,250,255,0.9);margin-bottom:10px}
    .badge{background:var(--accent);color:#fff;padding:6px 10px;border-radius:999px;font-weight:700}
    .btn{padding:8px 10px;border-radius:8px;border:0;cursor:pointer}
    .glow{position:absolute;border-radius:50%;filter:blur(60px);opacity:0.45}
    .g1{width:320px;height:320px;left:8%;top:8%;background:radial-gradient(circle,#c7a0ff33,#9b00ff11)}
    .g2{width:240px;height:240px;right:6%;bottom:10%;background:radial-gradient(circle,#a855f733,#7b2ce022)}
    @media (max-width:980px){.grid{grid-template-columns:1fr}.map{min-height:300px}}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="glow g1"></div>
    <div class="glow g2"></div>

    <div class="container">
      <div class="title">Track Your Ride</div>
      <div class="muted">Real-time tracking and ride status</div>

      <div style="margin-top:18px" class="grid">
        <div class="panel map" id="map">
          <div id="map-status">Initializing map...</div>
          <div id="coords" style="margin-top:12px;color:#556"></div>
        </div>

        <aside>
          <div class="panel" id="rides-panel">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
              <strong>Your Active Rides</strong>
              <div id="counts" class="muted">0</div>
            </div>
            <div id="rides-list"></div>
          </div>
        </aside>
      </div>
    </div>
  </div>

<script>
(function(){
  // access check: require localStorage flag 'ride_with_ree_access'
  const access = localStorage.getItem('ride_with_ree_access');
  if(!access){
    // redirect to home for access
    window.location.href = '/';
    return;
  }

  const mapStatus = document.getElementById('map-status');
  const coordsEl = document.getElementById('coords');
  const ridesList = document.getElementById('rides-list');
  const countsEl = document.getElementById('counts');

  let driverLocation = null;
  let selectedRide = null;

  function renderMap(){
    if(!driverLocation){
      mapStatus.textContent = 'Driver location not available yet';
      coordsEl.textContent = '';
    } else {
      mapStatus.textContent = 'Driver at: ' + driverLocation[0].toFixed(5) + ', ' + driverLocation[1].toFixed(5);
      coordsEl.textContent = 'lat ' + driverLocation[0].toFixed(5) + ' • lng ' + driverLocation[1].toFixed(5);
    }
  }

  // Simulate driver movement when a confirmed ride is selected
  function maybeStartSim(ride){
    if(!ride || ride.status !== 'confirmed'){
      driverLocation = null; renderMap(); return; }
    // start at base KC coordinates
    driverLocation = [39.0997, -94.5786]; renderMap();
    if(window._trackInterval) clearInterval(window._trackInterval);
    window._trackInterval = setInterval(()=>{
      driverLocation = [driverLocation[0] + (Math.random()-0.5)*0.002, driverLocation[1] + (Math.random()-0.5)*0.002];
      renderMap();
    }, 4000);
  }

  async function loadRides(){
    try{
      const r = await fetch('/api/bookings');
      const all = await r.json();
      // active: pending or confirmed
      const active = (all||[]).filter(x=> ['pending','requested','confirmed'].includes((x.status||'').toLowerCase()));
      renderRides(active.sort((a,b)=>(b.created||0)-(a.created||0)));
    }catch(e){ ridesList.innerHTML = '<div class="muted">Failed to load rides</div>'; }
  }

  function renderRides(arr){
    ridesList.innerHTML = '';
    countsEl.textContent = arr.length + ' active';
    if(arr.length===0){ ridesList.innerHTML = '<div class="muted">No active rides right now</div>'; return; }
    arr.forEach(r=>{
      const el = document.createElement('div'); el.className='ride-card';
      const status = (r.status||'').toUpperCase();
      el.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><div><strong>${escapeHtml(r.name||'Ride')}</strong><div class='muted' style='font-size:13px'>${escapeHtml(r.pickup||'')} → ${escapeHtml(r.destination||'')}</div></div><div style='text-align:right'><div style='margin-bottom:6px'><span class='badge'>${escapeHtml(status)}</span></div><div style='display:flex;gap:6px'><button class='btn' data-id='${escapeHtml(r.id)}' data-action='select'>View</button><button class='btn' data-id='${escapeHtml(r.id)}' data-action='track'>Track</button></div></div></div>`;
      ridesList.appendChild(el);
    });
    // wire buttons
    ridesList.querySelectorAll('button').forEach(b=>{
      b.onclick = (e)=>{
        const id = b.getAttribute('data-id');
        const act = b.getAttribute('data-action');
        const ride = arr.find(x=>x.id===id);
        if(act==='select'){ selectedRide = ride; maybeStartSim(ride); showDetails(ride); }
        if(act==='track'){ selectedRide = ride; maybeStartSim(ride); window.scrollTo({top:0,behavior:'smooth'}); }
      };
    });
  }

  function showDetails(ride){
    mapStatus.textContent = 'Selected: ' + (ride.name || 'Ride') + ' • status: ' + (ride.status||'');
  }

  function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

  // initial
  loadRides();
  setInterval(loadRides,7000);
  renderMap();

})();
</script>
</body>
</html>